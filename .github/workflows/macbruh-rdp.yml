name: "ðŸ–¥ï¸ MACBRUH-RDP: Real PC Experience"

on:
  workflow_dispatch:
    inputs:
      code:
        description: "ðŸ”‘ Remote Desktop Auth Code"
        required: true
      extra_packages:
        description: "Extra Chocolatey packages (e.g. git,python,vscode)"
        required: false
      keep_alive_minutes:
        description: "Session duration in minutes (10-43800, default 60)"
        required: false

jobs:
  build:
    name: "ðŸ–¥ï¸ MACBRUH-RDP Session"
    runs-on: windows-latest
    timeout-minutes: 43800

    steps:
    - name: "ðŸ›¡ï¸ Disable Firewall"
      run: |
        try { Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False }
        catch { Write-Host "Firewall disable failed, continuing..." }

    - name: "â¬†ï¸ Update Chocolatey"
      run: |
        choco upgrade chocolatey -y

    - name: "ðŸ› ï¸ Install Essentials (Chrome, CRD, 7zip, VLC, ffmpeg)"
      run: |
        choco install chrome-remote-desktop-host -y --ignore-checksums
        choco install googlechrome -y --ignore-checksums
        choco install 7zip -y --ignore-checksums
        choco install vlc -y --ignore-checksums
        choco install ffmpeg -y --ignore-checksums

    - name: "ðŸ§© Install Extra Packages (User-selected)"
      if: ${{ github.event.inputs.extra_packages != '' }}
      run: |
        $pkgs = "${{ github.event.inputs.extra_packages }}".Split(',')
        foreach ($pkg in $pkgs) {
          $clean = $pkg.Trim()
          if ($clean) {
            choco install $clean -y --ignore-checksums
            Write-Host "âœ… $clean installed."
          }
        }

    - name: "ðŸ”Š Enable Windows Audio Service"
      run: |
        try {
          Set-Service -Name "Audiosrv" -StartupType Automatic
          Start-Service -Name "Audiosrv"
          Write-Host "âœ… Audio service started."
        } catch {
          Write-Warning "Audio service could not be started."
        }

    - name: "ðŸŽ§ Install VB-Cable (Virtual Audio Device)"
      run: |
        $vcableUrl = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip"
        $zipPath = "$env:TEMP\VBCABLE.zip"
        $extractPath = "$env:TEMP\VBCABLE"
        Invoke-WebRequest -Uri $vcableUrl -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
        Start-Process -FilePath "$extractPath\VBCABLE_Setup_x64.exe" -ArgumentList "/S" -Wait

    - name: "ðŸ“Š System Info & Diagnostics"
      run: |
        Get-ComputerInfo | Out-File C:\Users\$Env:USERNAME\Documents\system-info.txt
        Get-Process | Sort-Object CPU -Descending | Select-Object -First 10 | Out-File C:\Users\$Env:USERNAME\Documents\top-processes.txt

    - name: "â¬†ï¸ Upload System Diagnostics"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: "system-diagnostics"
        path: |
          C:\Users\${{ env.USERNAME }}\Documents\system-info.txt
          C:\Users\${{ env.USERNAME }}\Documents\top-processes.txt

    - name: "Download and Extract Free Fire Ripper"
      continue-on-error: true
      run: |
        cd C:\Users\$Env:USERNAME\Documents
        try {
          Invoke-WebRequest -Uri "https://drive.usercontent.google.com/download?id=11EUFz6hufNT1g56-CmOJw9_KxMERZxhe&export=download" -OutFile ffripper.zip
          7z x ffripper.zip -y
        } catch {
          Write-Host "Download or extraction failed."
        }

    - name: "Start Chrome Remote Desktop"
      continue-on-error: true
      run: |
        function Start-RemoteDesktop {
          $paths = @("${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe", "${Env:PROGRAMFILES}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe")
          foreach ($path in $paths) {
              if (Test-Path $path) { & $path; return }
          }
          Write-Host "Chrome Remote Desktop's remoting_start_host.exe not found."
        }
        Start-RemoteDesktop

    - name: "Create Desktop Shortcuts"
      run: |
        $desktop = [Environment]::GetFolderPath("Desktop")
        $links = @(
          @{Target="C:\Users\$Env:USERNAME\Documents\FenixGaga\Engine\ProjectTitan.exe"; Link="$desktop\Free Fire.lnk"},
          @{Target="C:\Users\$Env:USERNAME\Documents\ninjaripper\x86\NinjaRipper.exe"; Link="$desktop\Ninjaripper.lnk"},
          @{Target="C:\Users\$Env:USERNAME\Documents\noesis\Noesis64.exe"; Link="$desktop\Noesis.lnk"}
        )
        foreach ($l in $links) {
          try {
            if (Test-Path $l.Target) {
              New-Item -ItemType SymbolicLink -Target $l.Target -Path $l.Link -Force
              Write-Host "Shortcut: $($l.Link) -> $($l.Target)"
            }
          } catch {
            Write-Warning "Failed to create shortcut: $($l.Link)"
          }
        }

    - name: "ðŸ–¥ï¸ Start Remote Desktop Session"
      continue-on-error: true
      run: |
        Write-Host "Connecting to VM with Remote Desktop"
        ${{ inputs.code }} --pin=444444

    - name: "â³ Keep Session Alive (User-Controlled)"
      run: |
        $minutes = [int]("${{ github.event.inputs.keep_alive_minutes }}")
        if (-not $minutes -or $minutes -lt 10) { $minutes = 60 }
        if ($minutes -gt 43800) { $minutes = 43800 }
        Write-Host "Keeping session alive for $minutes minutes."
        for ($i = $minutes; $i -gt 0; $i--) {
          Write-Host "Minutes remaining: $i"
          Start-Sleep -Seconds 60
        }

    - name: "ðŸ“ Workflow Summary"
      if: always()
      run: |
        echo "### MACBRUH-RDP Workflow Complete" >> $env:GITHUB_STEP_SUMMARY
        echo "- Extra Packages: ${{ github.event.inputs.extra_packages }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- Session kept alive for $minutes minutes" >> $env:GITHUB_STEP_SUMMARY

    - name: "ðŸ”” Discord Notification"
      if: always()
      run: |
        $webhookUrl = "${{ secrets.DISCORD_WEBHOOK }}"
        $content = '{"content": "MACBRUH-RDP workflow completed for '${{ github.repository }}'!"}'
        Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $content -ContentType 'application/json'
